#!/bin/bash
# Install Node + common NPM packages
# REQUIRES: 007-apt-update

source common


if [ `which 'node' >/dev/null; echo "$?"` == 0 ]; then
	init status "Remove existing Node installs"
	sudo apt purge nodejs
	sudo rm `which node`
fi

init status "Install NodeSource Apt PPA + Update Apt"
curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash -

init status "Install Node from Apt"
sudo apt install -y nodejs

init status "Install common Node system Apt packages"
sudo apt install -y imagemagick graphicsmagick potrace

if [ -e "$HOME/.npmrc" ]; then
	init skip "NPM config already exists"
else
	init status "Install NPM config"
	echo 'email=m@ttcarter.com' >~/.npmrc
	echo 'bin-links=true' >>~/.npmrc
	echo 'save=true' >>~/.npmrc
	echo 'spin=false' >>~/.npmrc
	echo 'loglevel=http' >>~/.npmrc
	echo 'registry=https://registry.npmjs.org' >>~/.npmrc
fi

init status "Upgrade NPM to latest"
sudo npm install -g npm@latest

init status "Install common global NPMs"
sudo npm install -g \
@hash-bang/pss \
depcheck \
fkill-cli \
fx \
gronk \
gulp \
hanson \
jay-repl \
jaywalker \
jshint \
json-prettify \
mongoosh \
mocha \
@momsfriendlydevco/cli-snip \
@momsfriendlydevco/extract \
@momsfriendlydevco/o \
@momsfriendlydevco/repl \
npm-check-updates \
pm2 \


if [ -e /usr/bin/json-prettify ]; then
	init skip "JSON prettifier already exists as /usr/bin/json"
else
	init status "Set up symlinks"
	sudo ln -s /usr/bin/json-prettify /usr/bin/json
fi

init status "Reset permissions on ~/.npm and /tmp/npm"
sudo chmod 0777 -R ~/.npm /tmp/npm

init status "Permit Node to have port 80 access"
init apt-install libcap2-bin
sudo setcap cap_net_bind_service=+ep /usr/bin/node

init status "Setup NODE_ENV"

if [ `init file-grep-matches "$HOME/.bashrc" "NODE_ENV"` == 1 ]; then
	init skip "NODE_ENV already setup"
else
	echo "Installing NODE_ENV into ~/.bashrc, assuming 'production'"
	echo "export NODE_ENV=production" >>~/.bashrc
	export NODE_ENV=production
fi
